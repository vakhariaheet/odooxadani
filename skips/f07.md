# Module M07: Automated Email Reminders

## Overview

**Estimated Time:** 45min

**Complexity:** Simple

**Type:** Backend-heavy

**Risk Level:** Low

**Dependencies:** F03 (Invoice Management)

## Problem Context

Freelancers need automated reminders for overdue invoices. This module provides scheduled email reminders to clients for unpaid invoices, with configurable reminder intervals.

## Technical Requirements

### Backend Tasks

- [ ] **Handler File:** Create `handlers/sendReminders.ts` with typed handler
  - Import: `APIGatewayProxyResultV2`, `successResponse`, `handleAsyncError`
  - Pattern: Scheduled Lambda (no auth required, triggered by EventBridge)
  - Query overdue invoices from DynamoDB
  - Send reminder emails to clients
  - Update last reminder timestamp

- [ ] **Handler File:** Create `handlers/scheduleReminder.ts` with typed handler
  - Import: `AuthenticatedAPIGatewayEvent`, `withRbacOwn`, `successResponse`, `handleAsyncError`
  - Pattern: `baseHandler` function + `export const handler = withRbacOwn(baseHandler, 'invoices', 'update')`
  - Allow freelancers to manually trigger reminder
  - Send immediate reminder email

- [ ] **Function Config:** Create YAML files for each handler
  - `functions/sendReminders.yml` - Scheduled function (daily at 9 AM)
  - `functions/scheduleReminder.yml` - POST /api/reminders/send/{invoiceId}

- [ ] **Service Layer:** Business logic in `services/ReminderService.ts`
  - Create service class with reminder logic
  - Instantiate service at module level: `const reminderService = new ReminderService()`
  - Methods: sendScheduledReminders, sendManualReminder
  - Query overdue invoices
  - Send email via SES
  - Update reminder timestamps

- [ ] **Type Definitions:** Add types to `types.ts` for requests/responses
  - ReminderConfig interface
  - ReminderLog interface

- [ ] **RBAC Verification:** Verify `config/permissions.ts` includes this module
  - Use existing 'invoices' module for permissions

- [ ] **AWS Service Integration:** Use shared/clients/\* wrappers
  - DynamoDB: `import { dynamodb } from '../../../shared/clients/dynamodb'`
  - SES: `import { sesClient } from '../../../shared/clients/ses'`
  - **NEVER import @aws-sdk packages directly**

- [ ] **Error Handling:** Use `handleAsyncError()` and `commonErrors.*` consistently

### Frontend Tasks

- [ ] **Components:**
  - `components/reminders/SendReminderButton.tsx` - Manual reminder button
  - `components/reminders/ReminderHistory.tsx` - Show reminder history

- [ ] **shadcn Components:**
  - Button, Badge, Tooltip

- [ ] **API Integration:**
  - Add method to useInvoices hook
  - Method: sendReminder(invoiceId)
  - Show success toast after sending

- [ ] **State Management:**
  - Local state for loading
  - Toast notifications

### Database Schema

**Note:** Add reminder fields to existing Invoice schema:

```
Additional fields in Invoice:
- lastReminderSentAt?: string (ISO timestamp)
- reminderCount: number (default: 0)
- reminderHistory?: Array<{
    sentAt: string,
    sentBy: 'system' | 'manual'
  }>
```

## External Services

### EventBridge (Scheduled Triggers)

- **Purpose:** Trigger reminder function daily
- **Setup Steps:**
  1. Configure in serverless.yml
  2. Set schedule expression (cron)
- **Environment Variables:** None required
- **Configuration:**
  ```yaml
  functions:
    sendReminders:
      handler: src/modules/reminders/handlers/sendReminders.handler
      events:
        - schedule:
            rate: cron(0 9 * * ? *) # Daily at 9 AM UTC
            enabled: true
  ```

### SES (Email Service)

- **Purpose:** Send reminder emails
- **Setup Steps:** Use existing SES client wrapper
- **Environment Variables:** `EMAIL_FROM`

## Implementation Guide

### Step 0: Study Phase (MANDATORY - Do This First)

**BEFORE writing any code, spend 15-20 minutes studying:**

1. **Review Guidelines:**

   ```bash
   cat guidelines/QUICK_REFERENCE.md
   ```

2. **Study SES Client Wrapper:**

   ```bash
   cat backend/src/shared/clients/ses.ts
   ```

3. **Study Invoice Module:**
   ```bash
   cat backend/src/modules/invoices/services/InvoiceService.ts
   ```

### Step 1: Backend Implementation

**File Structure:**

```
backend/src/modules/reminders/
├── handlers/
│   ├── sendReminders.ts
│   └── scheduleReminder.ts
├── functions/
│   ├── sendReminders.yml
│   └── scheduleReminder.yml
├── services/
│   └── ReminderService.ts
└── types.ts
```

**Implementation Order:**

1. Create types.ts
2. Create ReminderService.ts
3. Create handlers
4. Create YAML configs (include schedule event)
5. Update serverless.yml

### Step 2: Frontend Implementation

**File Structure:**

```
client/src/
└── components/reminders/
    ├── SendReminderButton.tsx
    └── ReminderHistory.tsx
```

**Implementation Order:**

1. Add sendReminder method to useInvoices hook
2. Create SendReminderButton component
3. Add button to invoice view page
4. Create ReminderHistory component (optional)

### Step 3: Serverless Configuration

**Update serverless.yml:**

```yaml
functions:
  # Email Reminders
  - ${file(src/modules/reminders/functions/sendReminders.yml)}
  - ${file(src/modules/reminders/functions/scheduleReminder.yml)}
```

### Step 4: Integration

- [ ] Test scheduled function locally
- [ ] Test manual reminder trigger
- [ ] Verify emails are sent
- [ ] Test reminder history tracking

## LLM Prompts for Implementation

**Backend Handler Creation:**

```
Create Lambda handlers for automated email reminders.

Requirements:
- sendReminders: Scheduled function (no auth), query overdue invoices, send emails
- scheduleReminder: Manual trigger with auth, send immediate reminder
- Use SES client wrapper for emails
- Update reminder timestamps in DynamoDB
- Handle errors gracefully
```

**Service Layer Creation:**

```
Create ReminderService class with reminder logic.

Requirements:
- Query overdue invoices (status='sent', dueDate < today)
- Filter invoices that need reminders (based on last reminder date)
- Send reminder emails via SES
- Update lastReminderSentAt and reminderCount
- Log reminder history
```

**Frontend Component Creation:**

```
Create SendReminderButton component.

Requirements:
- Button with email icon
- Show loading state
- Trigger manual reminder API
- Show success toast
- Disable if reminder sent recently
- Use shadcn Button component
```

## Acceptance Criteria

- [ ] Scheduled function runs daily at 9 AM
- [ ] Overdue invoices trigger reminder emails
- [ ] Freelancers can manually send reminders
- [ ] Reminder history is tracked
- [ ] Emails include invoice details and payment link
- [ ] Reminders respect frequency limits (e.g., max 1 per day)
- [ ] **Demo Ready:** Can manually send reminder in 10 seconds
- [ ] **Lambda Compatible:** Scheduled function works
- [ ] **Error Handling:** Graceful error handling
- [ ] **Email Delivery:** Emails sent successfully

## Testing Checklist

- [ ] **Manual API Testing:**
  - Trigger scheduled function manually
  - Send manual reminder: `POST /api/reminders/send/{invoiceId}`
  - Verify emails are sent
  - Check reminder timestamps updated
- [ ] **Frontend Testing:**
  - Send reminder button works
  - Loading state displays
  - Success toast shows
  - Button disabled after sending
- [ ] **Integration:** End-to-end reminder workflow
- [ ] **Edge Cases:**
  - No overdue invoices
  - Already sent reminder today
  - Invalid email address

## Deployment Checklist

- [ ] **Code Review:** Self-review completed
- [ ] **Serverless Config:** Added function imports
- [ ] **EventBridge Schedule:** Configured correctly
- [ ] **SES Configuration:** Verified
- [ ] **Environment Variables:** EMAIL_FROM set
- [ ] **Testing:** Manual testing completed

## Troubleshooting Guide

### Common Issues

1. **Scheduled Function Not Running**
   - Check EventBridge rule is enabled
   - Verify cron expression is correct
   - Check Lambda permissions
   - View CloudWatch logs

2. **Emails Not Sending**
   - Check SES configuration
   - Verify sender email is verified
   - Check recipient email format
   - Review SES sending limits

3. **Wrong Invoices Selected**
   - Verify query logic for overdue invoices
   - Check date comparison
   - Test with sample data
   - Review filter conditions

## Related Modules

- **Depends On:** F03 (Invoice Management)
- **Enables:** Automated payment follow-up
- **Conflicts With:** None
