# Module F04: Dashboard & Analytics

## Overview

**Estimated Time:** 1hr

**Complexity:** Medium

**Type:** Full-stack

**Risk Level:** Low

**Dependencies:** None

## Problem Context

Freelancers need a central dashboard to view their business metrics, recent activity, and key statistics. This module provides an overview of proposals, invoices, revenue, and payment status with visual charts and quick actions.

## Technical Requirements

### Backend Tasks

- [ ] **Handler File:** Create `handlers/getDashboardStats.ts` with typed handler
  - Import: `AuthenticatedAPIGatewayEvent`, `withRbacOwn`, `successResponse`, `handleAsyncError`
  - Pattern: `baseHandler` function + `export const handler = withRbacOwn(baseHandler, 'admin', 'read')`
  - Aggregate data from proposals, invoices, clients
  - Calculate key metrics (total revenue, pending payments, active proposals)
  - Return summary statistics

- [ ] **Handler File:** Create `handlers/getRecentActivity.ts` with typed handler
  - Import: `AuthenticatedAPIGatewayEvent`, `withRbacOwn`, `successResponse`, `handleAsyncError`
  - Pattern: `baseHandler` function + `export const handler = withRbacOwn(baseHandler, 'admin', 'read')`
  - Query recent proposals, invoices, and payments
  - Return chronological activity feed
  - Support pagination (limit, offset)

- [ ] **Handler File:** Create `handlers/getRevenueChart.ts` with typed handler
  - Import: `AuthenticatedAPIGatewayEvent`, `withRbacOwn`, `successResponse`, `handleAsyncError`
  - Pattern: `baseHandler` function + `export const handler = withRbacOwn(baseHandler, 'admin', 'read')`
  - Aggregate revenue by month/week
  - Support date range filtering
  - Return data formatted for charts

- [ ] **Function Config:** Create YAML files for each handler
  - `functions/getDashboardStats.yml` - GET /api/dashboard/stats
  - `functions/getRecentActivity.yml` - GET /api/dashboard/activity
  - `functions/getRevenueChart.yml` - GET /api/dashboard/revenue

- [ ] **Service Layer:** Business logic in `services/DashboardService.ts`
  - Create service class with methods for analytics
  - Instantiate service at module level: `const dashboardService = new DashboardService()`
  - Methods: getDashboardStats, getRecentActivity, getRevenueChart
  - Aggregate data from multiple modules
  - Calculate metrics and trends

- [ ] **Type Definitions:** Add types to `types.ts` for requests/responses
  - DashboardStats interface (totalRevenue, pendingPayments, activeProposals, etc.)
  - ActivityItem interface (type, title, timestamp, status)
  - RevenueChartData interface (labels, datasets)
  - DashboardResponse types

- [ ] **RBAC Verification:** Verify `config/permissions.ts` includes this module
  - Module 'admin' should be in `ALL_MODULES` list
  - Freelancer role has readOwn access
  - Admin role has full access

- [ ] **AWS Service Integration:** Use shared/clients/\* wrappers
  - DynamoDB: `import { dynamodb } from '../../../shared/clients/dynamodb'`
  - Query multiple tables/indexes for aggregation
  - **NEVER import @aws-sdk packages directly**

- [ ] **Error Handling:** Use `handleAsyncError()` and `commonErrors.*` consistently

### Frontend Tasks

- [ ] **Pages/Components:**
  - `pages/DashboardPage.tsx` - Main dashboard page
  - `components/dashboard/StatsCards.tsx` - Key metrics cards
  - `components/dashboard/RevenueChart.tsx` - Revenue chart (line/bar)
  - `components/dashboard/RecentActivity.tsx` - Activity feed
  - `components/dashboard/QuickActions.tsx` - Quick action buttons
  - `components/dashboard/PaymentStatus.tsx` - Payment status overview
  - `components/dashboard/UpcomingDueDates.tsx` - Invoices due soon

- [ ] **shadcn Components:**
  - Card, Badge, Button, Table, Tabs, Calendar, Chart (recharts)

- [ ] **API Integration:**
  - Create `hooks/useDashboard.ts` with React Query
  - Methods: useDashboardStats, useRecentActivity, useRevenueChart
  - Handle loading/error states
  - Auto-refresh data periodically

- [ ] **State Management:**
  - React Query for server state
  - Local state for date range filters, chart type selection

- [ ] **Routing:**
  - `/dashboard` - Main dashboard page (default route after login)

### Database Schema (Queries)

**Note:** This module queries existing data from other modules, no new tables needed.

**Queries:**

```
1. Get all proposals for freelancer:
   PK: FREELANCER#{freelancerId}, SK: begins_with(PROPOSAL#)

2. Get all invoices for freelancer:
   PK: FREELANCER#{freelancerId}, SK: begins_with(INVOICE#)

3. Get all clients for freelancer:
   PK: FREELANCER#{freelancerId}, SK: begins_with(CLIENT#)

4. Get invoices by status (using GSI):
   GSI2PK: STATUS#{status}, GSI2SK: DUEDATE#{dueDate}
```

## External Services

None required for this module.

## Implementation Guide

### Step 0: Study Phase (MANDATORY - Do This First)

**BEFORE writing any code, spend 15-20 minutes studying:**

1. **Review Guidelines:**

   ```bash
   cat guidelines/QUICK_REFERENCE.md
   cat guidelines/CODING_GUIDELINES.md
   ```

2. **Study Existing Admin Dashboard:**

   ```bash
   cat client/src/components/AdminDashboard.tsx
   cat client/src/components/admin/index.ts
   ```

3. **Study Data Aggregation Patterns:**
   - Review how to query multiple DynamoDB items
   - Understand GSI usage for filtering
   - Learn chart library (recharts) usage

### Step 1: Backend Implementation

**File Structure:**

```
backend/src/modules/dashboard/
├── handlers/
│   ├── getDashboardStats.ts
│   ├── getRecentActivity.ts
│   └── getRevenueChart.ts
├── functions/
│   ├── getDashboardStats.yml
│   ├── getRecentActivity.yml
│   └── getRevenueChart.yml
├── services/
│   └── DashboardService.ts
└── types.ts
```

**Implementation Order:**

1. Create types.ts with all interfaces
2. Create DashboardService.ts with aggregation logic
3. Create handlers (stats, activity, revenue)
4. Create YAML configs
5. Update serverless.yml

### Step 2: Frontend Implementation

**File Structure:**

```
client/src/
├── pages/
│   └── DashboardPage.tsx
├── components/dashboard/
│   ├── StatsCards.tsx
│   ├── RevenueChart.tsx
│   ├── RecentActivity.tsx
│   ├── QuickActions.tsx
│   ├── PaymentStatus.tsx
│   └── UpcomingDueDates.tsx
├── hooks/
│   └── useDashboard.ts
└── types/
    └── dashboard.ts
```

**Implementation Order:**

1. Create types/dashboard.ts
2. Create hooks/useDashboard.ts
3. Create StatsCards component (key metrics)
4. Create RevenueChart component (using recharts)
5. Create RecentActivity component
6. Create DashboardPage (compose all components)
7. Update App.tsx routing

### Step 3: Serverless Configuration

**Update serverless.yml:**

```yaml
functions:
  # Dashboard & Analytics
  - ${file(src/modules/dashboard/functions/getDashboardStats.yml)}
  - ${file(src/modules/dashboard/functions/getRecentActivity.yml)}
  - ${file(src/modules/dashboard/functions/getRevenueChart.yml)}
```

### Step 4: Integration

- [ ] Test API endpoints
- [ ] Connect frontend to backend
- [ ] Verify calculations are accurate
- [ ] Test chart rendering

## LLM Prompts for Implementation

**Backend Handler Creation:**

```
Create Lambda handlers for dashboard analytics following existing patterns.

Requirements:
- Use AuthenticatedAPIGatewayEvent and withRbacOwn
- Aggregate data from proposals, invoices, clients modules
- Calculate key metrics (revenue, pending payments, active proposals)
- Return data formatted for frontend charts
- Implement handlers: getDashboardStats, getRecentActivity, getRevenueChart
```

**Service Layer Creation:**

```
Create DashboardService class with analytics logic.

Requirements:
- Query multiple DynamoDB tables/indexes
- Aggregate data from proposals, invoices, clients
- Calculate metrics: total revenue, pending payments, conversion rate
- Format data for charts (labels, datasets)
- Support date range filtering
```

**Frontend Component Creation:**

```
Create dashboard components with charts and metrics.

Requirements:
- StatsCards: Display key metrics in card grid
- RevenueChart: Line/bar chart using recharts
- RecentActivity: Timeline of recent actions
- QuickActions: Buttons for common tasks
- Use shadcn/ui Card, Badge, Button components
- Follow existing AdminDashboard pattern
```

## Acceptance Criteria

- [ ] Dashboard displays key metrics (revenue, proposals, invoices)
- [ ] Revenue chart shows monthly/weekly trends
- [ ] Recent activity feed shows latest actions
- [ ] Quick action buttons for common tasks
- [ ] Payment status overview with pending/paid breakdown
- [ ] Upcoming due dates for invoices
- [ ] **Demo Ready:** Dashboard loads and displays data in 30 seconds
- [ ] **Full-Stack Working:** Frontend fetches and displays backend data
- [ ] **Lambda Compatible:** All handlers work in serverless
- [ ] **Error Handling:** Graceful error handling for missing data
- [ ] **Mobile Responsive:** Dashboard works on mobile devices

## Testing Checklist

- [ ] **Manual API Testing:**
  - Get dashboard stats: `GET /api/dashboard/stats`
  - Get recent activity: `GET /api/dashboard/activity`
  - Get revenue chart: `GET /api/dashboard/revenue?range=30d`
  - Verify calculations are accurate
  - Test with different date ranges
- [ ] **Frontend Testing:**
  - Stats cards display correct numbers
  - Revenue chart renders correctly
  - Activity feed shows recent items
  - Quick actions navigate correctly
  - Loading states work
- [ ] **Integration:** Dashboard loads all data correctly
- [ ] **Edge Cases:**
  - Empty state (no data yet)
  - Large datasets (pagination)
  - Date range edge cases

## Deployment Checklist

- [ ] **Code Review:** Self-review completed
- [ ] **Serverless Config:** Added function imports
- [ ] **RBAC Config:** Verified permissions
- [ ] **Types:** Exported types for frontend
- [ ] **Testing:** Manual testing completed
- [ ] **Charts:** Verified recharts library is installed

## Troubleshooting Guide

### Common Issues

1. **Slow Dashboard Loading**
   - Optimize DynamoDB queries (use indexes)
   - Implement caching for stats
   - Paginate activity feed
   - Use parallel queries where possible

2. **Incorrect Calculations**
   - Verify aggregation logic
   - Check date range filtering
   - Ensure all statuses are included
   - Test with edge cases (no data, single item)

3. **Chart Not Rendering**
   - Check recharts is installed: `npm install recharts`
   - Verify data format matches chart requirements
   - Check for console errors
   - Ensure data is not empty

4. **Activity Feed Empty**
   - Verify query returns data
   - Check date range filter
   - Ensure activity items have timestamps
   - Test with sample data

## Related Modules

- **Depends On:** None (Foundation module, but displays data from F01, F02, F03)
- **Enables:** Better visibility into business metrics
- **Conflicts With:** None
