# Module M06: PDF Generation & Export

## Overview

**Estimated Time:** 1hr

**Complexity:** Medium

**Type:** Backend-heavy

**Risk Level:** Medium

**Dependencies:** F01 (Proposal Management), F03 (Invoice Management)

## Problem Context

Freelancers and clients need to download professional PDF versions of proposals and invoices. This module provides PDF generation with customizable templates, branding, and export functionality.

## Technical Requirements

### Backend Tasks

- [ ] **Handler File:** Create `handlers/generateProposalPDF.ts` with typed handler
  - Import: `AuthenticatedAPIGatewayEvent`, `withRbac`, `successResponse`, `handleAsyncError`
  - Pattern: `baseHandler` function + `export const handler = withRbac(baseHandler, 'proposals', 'read')`
  - Generate PDF from proposal data
  - Upload to S3
  - Return presigned download URL

- [ ] **Handler File:** Create `handlers/generateInvoicePDF.ts` with typed handler
  - Import: `AuthenticatedAPIGatewayEvent`, `withRbac`, `successResponse`, `handleAsyncError`
  - Pattern: `baseHandler` function + `export const handler = withRbac(baseHandler, 'invoices', 'read')`
  - Generate PDF from invoice data
  - Include line items table
  - Upload to S3
  - Return presigned download URL

- [ ] **Function Config:** Create YAML files for each handler
  - `functions/generateProposalPDF.yml` - POST /api/pdf/proposal/{id}
  - `functions/generateInvoicePDF.yml` - POST /api/pdf/invoice/{id}

- [ ] **Service Layer:** Business logic in `services/PDFService.ts`
  - Create service class with PDF generation methods
  - Instantiate service at module level: `const pdfService = new PDFService()`
  - Methods: generateProposalPDF, generateInvoicePDF
  - Use jsPDF for PDF generation
  - Create professional templates
  - Support custom branding (logo, colors)

- [ ] **Type Definitions:** Add types to `types.ts` for requests/responses
  - PDFGenerationRequest interface
  - PDFGenerationResponse interface (with download URL)
  - PDFTemplate type

- [ ] **RBAC Verification:** Verify `config/permissions.ts` includes this module
  - Use existing 'proposals' and 'invoices' modules for permissions
  - Both freelancer and client can generate PDFs

- [ ] **AWS Service Integration:** Use shared/clients/\* wrappers
  - S3: `import { s3Client } from '../../../shared/clients/s3'`
  - DynamoDB: `import { dynamodb } from '../../../shared/clients/dynamodb'` (to fetch data)
  - **NEVER import @aws-sdk packages directly**

- [ ] **Error Handling:** Use `handleAsyncError()` and `commonErrors.*` consistently

### Frontend Tasks

- [ ] **Components:**
  - `components/pdf/PDFDownloadButton.tsx` - Button to trigger PDF generation
  - `components/pdf/PDFPreview.tsx` - Preview PDF before download (optional)

- [ ] **shadcn Components:**
  - Button, Dialog, Spinner

- [ ] **API Integration:**
  - Add methods to existing hooks (useProposals, useInvoices)
  - Methods: generateProposalPDF, generateInvoicePDF
  - Handle loading state during generation
  - Auto-download PDF after generation

- [ ] **State Management:**
  - Local state for PDF generation loading
  - Toast notifications for success/error

### Database Schema

**Note:** No new tables needed. Queries existing proposals and invoices.

**S3 Storage:**

```
Bucket: {S3_BUCKET_NAME}
Path: pdfs/{type}/{id}/{timestamp}.pdf

Example:
- pdfs/proposals/prop_123/2024-01-15T10-30-00.pdf
- pdfs/invoices/inv_456/2024-01-15T10-30-00.pdf
```

## External Services

### jsPDF (PDF Generation)

- **Purpose:** Generate PDF documents in browser or Node.js
- **Setup Steps:**
  1. Install: `npm install jspdf`
  2. Optional: Install jspdf-autotable for tables: `npm install jspdf-autotable`
- **Environment Variables:** None required
- **NPM Package:** `npm install jspdf jspdf-autotable`
- **Code Pattern:**

  ```typescript
  import jsPDF from 'jspdf';
  import autoTable from 'jspdf-autotable';

  const doc = new jsPDF();

  // Add header
  doc.setFontSize(20);
  doc.text('INVOICE', 20, 20);

  // Add content
  doc.setFontSize(12);
  doc.text(`Invoice #: ${invoiceNumber}`, 20, 40);

  // Add table
  autoTable(doc, {
    head: [['Description', 'Quantity', 'Rate', 'Amount']],
    body: lineItems.map((item) => [item.description, item.quantity, item.rate, item.amount]),
    startY: 60,
  });

  // Generate buffer
  const pdfBuffer = doc.output('arraybuffer');
  ```

### S3 (PDF Storage)

- **Purpose:** Store generated PDFs
- **Setup Steps:** Use existing S3 client wrapper
- **Environment Variables:** `S3_BUCKET_NAME`

## Implementation Guide

### Step 0: Study Phase (MANDATORY - Do This First)

**BEFORE writing any code, spend 15-20 minutes studying:**

1. **Review Guidelines:**

   ```bash
   cat guidelines/QUICK_REFERENCE.md
   ```

2. **Study S3 Client Wrapper:**

   ```bash
   cat backend/src/shared/clients/s3.ts
   ```

3. **Research jsPDF:**
   - Read jsPDF documentation
   - Look at jspdf-autotable examples
   - Understand PDF generation in Node.js

### Step 1: Backend Implementation

**File Structure:**

```
backend/src/modules/pdf/
├── handlers/
│   ├── generateProposalPDF.ts
│   └── generateInvoicePDF.ts
├── functions/
│   ├── generateProposalPDF.yml
│   └── generateInvoicePDF.yml
├── services/
│   └── PDFService.ts
├── templates/
│   ├── proposalTemplate.ts
│   └── invoiceTemplate.ts
└── types.ts
```

**Implementation Order:**

1. Create types.ts
2. Create PDF templates (proposalTemplate, invoiceTemplate)
3. Create PDFService.ts with generation logic
4. Create handlers
5. Create YAML configs
6. Update serverless.yml

### Step 2: Frontend Implementation

**File Structure:**

```
client/src/
├── components/pdf/
│   ├── PDFDownloadButton.tsx
│   └── PDFPreview.tsx (optional)
└── hooks/
    └── usePDF.ts
```

**Implementation Order:**

1. Create usePDF.ts hook
2. Create PDFDownloadButton component
3. Add download buttons to proposal and invoice views
4. Test PDF generation and download

### Step 3: Serverless Configuration

**Update serverless.yml:**

```yaml
functions:
  # PDF Generation
  - ${file(src/modules/pdf/functions/generateProposalPDF.yml)}
  - ${file(src/modules/pdf/functions/generateInvoicePDF.yml)}
```

### Step 4: Integration

- [ ] Test PDF generation for proposals
- [ ] Test PDF generation for invoices
- [ ] Verify PDFs are stored in S3
- [ ] Test download functionality
- [ ] Verify PDF formatting and layout

## LLM Prompts for Implementation

**Backend Handler Creation:**

```
Create Lambda handlers for PDF generation.

Requirements:
- Use AuthenticatedAPIGatewayEvent
- Fetch proposal/invoice data from DynamoDB
- Generate PDF using jsPDF and jspdf-autotable
- Upload PDF to S3 using s3Client wrapper
- Return presigned download URL
- Handle errors gracefully
```

**Service Layer Creation:**

```
Create PDFService class with PDF generation logic.

Requirements:
- Use jsPDF for PDF creation
- Use jspdf-autotable for invoice line items
- Create professional templates with:
  - Header with logo/branding
  - Client and freelancer details
  - Content (proposal/invoice details)
  - Footer with terms
- Upload generated PDF to S3
- Return presigned URL for download
```

**Frontend Component Creation:**

```
Create PDFDownloadButton component.

Requirements:
- Button with download icon
- Show loading spinner during generation
- Trigger PDF generation API call
- Auto-download PDF when ready
- Show success/error toast
- Use shadcn Button component
```

## Acceptance Criteria

- [ ] Freelancers can generate PDF for any proposal
- [ ] Freelancers can generate PDF for any invoice
- [ ] Clients can download PDFs for proposals/invoices sent to them
- [ ] PDFs have professional formatting
- [ ] PDFs include all relevant information
- [ ] Invoice PDFs include line items table
- [ ] PDFs are stored in S3
- [ ] Download links expire after 1 hour (presigned URL)
- [ ] **Demo Ready:** Can generate and download PDF in 30 seconds
- [ ] **Lambda Compatible:** PDF generation works in Lambda
- [ ] **Error Handling:** Graceful error handling
- [ ] **Mobile Responsive:** Download works on mobile

## Testing Checklist

- [ ] **Manual API Testing:**
  - Generate proposal PDF: `POST /api/pdf/proposal/{id}`
  - Generate invoice PDF: `POST /api/pdf/invoice/{id}`
  - Verify PDF is created
  - Verify PDF is uploaded to S3
  - Verify presigned URL works
  - Test PDF download
- [ ] **Frontend Testing:**
  - Download button works
  - Loading state displays
  - PDF downloads automatically
  - Success toast shows
  - Error handling works
- [ ] **Integration:** End-to-end PDF generation and download
- [ ] **Edge Cases:**
  - Large invoices with many line items
  - Long proposal descriptions
  - Special characters in content
  - Missing optional fields

## Deployment Checklist

- [ ] **Code Review:** Self-review completed
- [ ] **Serverless Config:** Added function imports
- [ ] **S3 Bucket:** Configured with proper permissions
- [ ] **Environment Variables:** S3_BUCKET_NAME set
- [ ] **NPM Packages:** jspdf, jspdf-autotable installed
- [ ] **Lambda Memory:** Increased if needed (512MB recommended)
- [ ] **Testing:** Manual testing completed

## Troubleshooting Guide

### Common Issues

1. **PDF Generation Fails**
   - Check jsPDF is installed correctly
   - Verify data format matches template
   - Check Lambda memory limits (increase to 512MB)
   - Test with sample data locally

2. **PDF Upload to S3 Fails**
   - Check S3 permissions
   - Verify bucket name
   - Check S3 client wrapper usage
   - Verify IAM role has S3 write permissions

3. **Download Link Not Working**
   - Check presigned URL expiration
   - Verify S3 bucket CORS settings
   - Test URL in browser directly
   - Check S3 object exists

4. **PDF Formatting Issues**
   - Adjust jsPDF page size and margins
   - Test with different content lengths
   - Use autoTable for better table formatting
   - Check font sizes and spacing

## Related Modules

- **Depends On:** F01 (Proposal Management), F03 (Invoice Management)
- **Enables:** Professional document export
- **Conflicts With:** None
